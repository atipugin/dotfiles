#!/usr/bin/env bash

set -euo pipefail

source "$HOME/.restic/env.bash"

_say() {
  printf "[%s] %s\n" "$(date +"%Y-%m-%d %H:%M:%S")" "$1"
}

_restic() {
  /opt/homebrew/bin/restic "$@"
}

_say "Starting backup"
printf "\n"

_restic backup \
  --host="$RESTIC_HOST" \
  --cleanup-cache \
  --compression=max \
  --exclude-caches \
  --exclude-file="$HOME/.restic/exclude" \
  "${RESTIC_BACKUP_DIRS[@]}" 2>&1

if [ -n "${RESTIC_POST_BACKUP_COMMAND:-}" ]; then
  printf "\n"
  _say "Running post-backup command"
  eval "$RESTIC_POST_BACKUP_COMMAND"
fi

printf "\n"
_say "Backup finished"
